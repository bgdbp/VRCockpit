using System;
using System.Net.Sockets;
using System.Net;
using UnityEngine;
using System.Threading.Tasks;
using System.Text;
using System.Linq;
using System.Text.Json;
using Unity.Collections.LowLevel.Unsafe;

public class VRCSocketClient : MonoBehaviour
{
    public static VRCSocketClient Instance;
    TcpClient client;

    private async void OnEnable()
    {
        await ConnectToServer();
        Instance = this;
    }

    private void OnDisable()
    {
        client.Close();
    }

    public async Task SendRequest(VRCRequest request)
    {
        var networkStream = client.GetStream();
        string message = JsonSerializer.Serialize(request);

        byte[] bytes = Encoding.UTF8.GetBytes(message);
        await networkStream.WriteAsync(bytes, 0, bytes.Length);
    }

    public async Task ConnectToServer()
	{
        string hostName = Dns.GetHostName();
        IPHostEntry localhost = Dns.GetHostEntry(hostName);
        IPAddress localhostIP = localhost.AddressList[0];
        IPEndPoint ipEndPoint = new (localhostIP, 11003);


        client = new TcpClient(ipEndPoint);
        await client.ConnectAsync(ipEndPoint.Address, 11004);

        byte[] bytes = Encoding.UTF8.GetBytes("[");
        await networkStream.WriteAsync(bytes, 0, bytes.Length);

        // test requests to make sure we're able to communicate with the server
        RequestVRCKnob rKnob = new ("TestKnob", 0.123456f);
        await SendRequest(rKnob);

        RequestVRCToggle rToggle = new ("TestToggle", isOn: false);
        await SendRequest(rToggle);

        RequestVRCButton rButton = new ("TestButton", isPressed: true);
        await SendRequest(rButton);
    }
}
